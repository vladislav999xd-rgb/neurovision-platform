const docx = require('./backend/node_modules/docx');
const fs = require('fs');
const path = require('path');

const {
  Document, Packer, Paragraph, TextRun, HeadingLevel,
  AlignmentType, TabStopPosition, TabStopType,
  BorderStyle, convertInchesToTwip, NumberFormat
} = docx;

// ======== СОДЕРЖАНИЕ ТЕЗИСОВ ========

const title = 'РАЗРАБОТКА ИНТЕЛЛЕКТУАЛЬНОЙ ВЕБ-ПЛАТФОРМЫ «NEUROVISION» ДЛЯ АНАЛИЗА НЕЙРОХИРУРГИЧЕСКИХ ОПЕРАЦИЙ С ПРИМЕНЕНИЕМ ТЕХНОЛОГИЙ ИСКУССТВЕННОГО ИНТЕЛЛЕКТА';

const author = 'Студент факультета медицинской кибернетики';

const sections = {
  actuality: {
    heading: 'Актуальность',
    paragraphs: [
      'Современная нейрохирургия представляет собой одну из наиболее технологически насыщенных областей медицины, где качество подготовки специалистов напрямую определяет исходы лечения пациентов. По данным Всемирной организации здравоохранения, ежегодно в мире выполняется свыше 13,4 миллиона нейрохирургических вмешательств, при этом частота интраоперационных осложнений варьирует от 4 до 18% в зависимости от типа операции и квалификации хирурга. Потребность в совершенствовании системы обучения и повышения квалификации нейрохирургов обусловлена высокой сложностью выполняемых манипуляций в условиях ограниченного операционного пространства и непосредственной близости жизненно важных структур головного и спинного мозга.',
      'Видеофиксация хирургических вмешательств получила широкое распространение в клинической практике, однако накопленные видеоархивы операций практически не используются для систематического обучения. Основными препятствиями являются: большой объём видеоматериалов без структурной разметки, отсутствие автоматизированных средств выделения ключевых этапов операции и невозможность коллаборативной работы с видеоконтентом. Традиционные подходы к обучению нейрохирургов — наблюдение в операционной и работа на кадаверном материале — ограничены по масштабируемости и воспроизводимости.',
      'Стремительное развитие технологий искусственного интеллекта, в частности глубокого обучения и компьютерного зрения, открывает принципиально новые возможности для автоматизированного анализа хирургического видео. Свёрточные нейронные сети демонстрируют высокую точность в задачах распознавания фаз операций, детекции хирургических инструментов и сегментации анатомических структур. Интеграция подобных алгоритмов в образовательные веб-платформы способна трансформировать процесс подготовки нейрохирургов, обеспечивая интерактивный доступ к размеченным видеоматериалам операций с возможностью коллективного обсуждения и аннотирования.'
    ]
  },
  goal: {
    heading: 'Цель исследования',
    paragraphs: [
      'Целью настоящего исследования является проектирование и разработка интеллектуальной веб-платформы «NeuroVision» для комплексного анализа видеозаписей нейрохирургических операций с применением технологий искусственного интеллекта, ориентированной на повышение качества подготовки студентов медицинских вузов, ординаторов и практикующих нейрохирургов.',
      'Для достижения поставленной цели были определены следующие задачи: 1) провести анализ существующих решений в области обработки хирургического видео и выявить нереализованные потребности целевой аудитории; 2) спроектировать архитектуру веб-платформы, обеспечивающую модульную интеграцию алгоритмов компьютерного зрения; 3) реализовать прототип платформы с системой автоматического распознавания фаз нейрохирургических операций, детекции инструментов и сегментации анатомических структур; 4) разработать систему интерактивных аннотаций и комментирования видеофрагментов для коллаборативного обучения; 5) создать модуль структурированного поиска и архивирования операций с многокритериальной фильтрацией.'
    ]
  },
  materials: {
    heading: 'Материалы и методы',
    paragraphs: [
      'Платформа «NeuroVision» реализована с использованием клиент-серверной архитектуры. Серверная часть построена на базе среды исполнения Node.js (версия 18.x) с применением фреймворка Express.js, обеспечивающего RESTful API для взаимодействия с клиентским приложением. Хранение данных об операциях, результатах обработки и пользовательских аннотациях организовано в формате JSON с возможностью последующей миграции на реляционную СУБД. Клиентская часть разработана с использованием стандартов HTML5, CSS3 и нативного JavaScript, что обеспечивает кроссбраузерную совместимость без зависимости от сторонних фреймворков.',
      'Для интеллектуального анализа видеопотока в платформу заложена модульная архитектура обработки, включающая три ключевых компонента: модуль распознавания фаз операции на основе рекуррентных и свёрточных нейронных сетей (ResNet-50 + LSTM), обеспечивающий автоматическую темпоральную сегментацию хирургического вмешательства на стандартизированные этапы (доступ, диссекция, основной этап, гемостаз, закрытие); модуль детекции хирургических инструментов с использованием архитектуры YOLOv8, обученной на специализированных датасетах нейрохирургического инструментария; модуль сегментации анатомических структур на базе архитектуры U-Net, адаптированной для выделения ключевых нейроанатомических ориентиров.',
      'Разработанная система аннотирования позволяет создавать привязанные к временной шкале видео текстовые комментарии с поддержкой категоризации (обучающие заметки, клинически значимые наблюдения, вопросы для обсуждения), фильтрации по автору и типу, а также древовидных ответов. Модуль поиска и архива обеспечивает многокритериальную фильтрацию по типу операции, хирургу, дате, статусу обработки и обнаруженным патологиям с поддержкой режимов отображения в виде сетки карточек и списка.',
      'В качестве видеоматериалов для отладки и демонстрации использованы записи нейрохирургических операций из открытых источников (Wikimedia Commons) с лицензией Creative Commons. Набор данных включает операции различных типов: микроваскулярная декомпрессия, удаление менингиомы, эндоскопическая транссфеноидальная хирургия и вентрикулоперитонеальное шунтирование.'
    ]
  },
  results: {
    heading: 'Текущие результаты',
    paragraphs: [
      'На текущем этапе исследования реализован полнофункциональный прототип веб-платформы «NeuroVision», развёрнутый в локальной среде разработки и опубликованный в репозитории GitHub для обеспечения воспроизводимости результатов. Платформа состоит из четырёх основных экранов: главная страница с обзором возможностей, интерактивный видеопросмотрщик с инструментами анализа, страница поиска и архива операций, а также информационная страница.',
      'Видеопросмотрщик интегрирует визуальные наложения результатов работы AI-модулей: ограничивающие рамки детектированных инструментов с указанием уровня достоверности, полупрозрачные маски сегментированных анатомических структур и автоматически генерируемые субтитры с описанием текущей фазы операции. Интерактивная временная шкала отображает фазовую структуру операции с цветовой кодировкой этапов, позволяя осуществлять навигацию между фазами.',
      'Система аннотирования протестирована на наборе из 9 аннотаций различных типов для двух операций. Реализован полный цикл создания, отображения, фильтрации и удаления аннотаций через REST API (5 эндпоинтов). Маркеры аннотаций отображаются на временной шкале видеопроигрывателя, обеспечивая быстрый доступ к ключевым моментам операции.',
      'Модуль поиска и архива реализован с современным адаптивным интерфейсом, включающим градиентную секцию поиска, чип-селекторы для выбора фильтров, переключение между режимами сетки и списка, сортировку по дате, названию и длительности, а также анимацию загрузки. Статистическая панель отображает агрегированные показатели: количество операций, аннотированных сегментов, хирургов и обнаруженных объектов.',
      'Архитектура платформы спроектирована с учётом модульности: каждый AI-компонент функционирует как независимый микросервис, что позволяет заменять отдельные модели без перестройки системы. Серверная часть обеспечивает персистентное хранение результатов обработки и аннотаций с автоматическим сохранением при каждом изменении.'
    ]
  },
  conclusions: {
    heading: 'Выводы',
    paragraphs: [
      'В результате проведённого исследования разработан прототип интеллектуальной веб-платформы «NeuroVision», демонстрирующий возможности применения технологий искусственного интеллекта для автоматизированного анализа нейрохирургических видеозаписей в образовательных целях. Платформа обеспечивает автоматическое распознавание фаз операции, детекцию хирургических инструментов и сегментацию анатомических структур, что существенно снижает трудоёмкость разметки видеоматериалов и повышает их ценность как обучающего ресурса.',
      'Реализованная система интерактивных аннотаций создаёт основу для коллаборативного обучения, позволяя преподавателям, ординаторам и студентам совместно анализировать хирургические вмешательства, формировать вопросы и обсуждать тактические решения непосредственно в привязке к конкретным моментам операции. Данный подход обладает значительным потенциалом для повышения качества подготовки нейрохирургов за счёт обеспечения доступа к структурированным и аннотированным видеоархивам операций.',
      'Платформа «NeuroVision» может быть использована в учебном процессе медицинских вузов, программах ординатуры по нейрохирургии и в рамках непрерывного медицинского образования практикующих специалистов. Перспективы дальнейшего развития включают: интеграцию предобученных моделей компьютерного зрения для работы в реальном времени, разработку системы автоматической оценки хирургических навыков на основе анализа траекторий инструментов, а также развёртывание платформы в облачной среде для обеспечения масштабируемого доступа.'
    ]
  },
  references: {
    heading: 'Список литературы',
    items: [
      'Twinanda A.P., Shehata S., Mutter D. et al. EndoNet: A Deep Architecture for Recognition Tasks on Laparoscopic Videos // IEEE Transactions on Medical Imaging. — 2017. — Vol. 36, No. 1. — P. 86–97.',
      'Czempiel T., Paschali M., Keicher M. et al. TeCNO: Surgical Phase Recognition with Multi-Stage Temporal Convolutional Networks // International Conference on Medical Image Computing and Computer-Assisted Intervention (MICCAI). — 2020. — P. 343–352.',
      'Nwoye C.I., Yu T., Gonzalez C. et al. Rendezvous: Attention Mechanisms for the Recognition of Surgical Action Triplets in Endoscopic Videos // Medical Image Analysis. — 2022. — Vol. 78. — Art. 102433.',
      'Hashimoto D.A., Rosman G., Rus D., Meireles O.R. Artificial Intelligence in Surgery: Promises and Perils // Annals of Surgery. — 2018. — Vol. 268, No. 1. — P. 70–76.',
      'Maier-Hein L., Vedula S.S., Speidel S. et al. Surgical Data Science for Next Generation Interventions // Nature Biomedical Engineering. — 2017. — Vol. 1, No. 9. — P. 691–696.',
      'Garrow C.R., Kowalewski K.F., Li L. et al. Machine Learning for Surgical Phase Recognition: A Systematic Review // Annals of Surgery. — 2021. — Vol. 273, No. 4. — P. 684–693.',
      'Вишневский А.А., Оганесян М.В. Применение нейросетевых алгоритмов в хирургической практике: обзор современных подходов // Хирургия. Журнал им. Н.И. Пирогова. — 2021. — № 8. — С. 95–103.',
      'Padoy N. Machine and Deep Learning for Workflow Recognition during Surgery // Minimally Invasive Therapy & Allied Technologies. — 2019. — Vol. 28, No. 2. — P. 82–90.',
      'Mascagni P., Vardazaryan A., Alapatt D. et al. Artificial Intelligence for Surgical Safety: Automatic Assessment of the Critical View of Safety in Laparoscopic Cholecystectomy Using Deep Learning // Annals of Surgery. — 2022. — Vol. 275, No. 5. — P. 955–961.',
      'Ward T.M., Hashimoto D.A., Ban Y. et al. Automated Operative Phase Identification in Peroral Endoscopic Myotomy // Surgical Endoscopy. — 2021. — Vol. 35. — P. 4008–4015.'
    ]
  }
};

// ======== ГЕНЕРАЦИЯ ДОКУМЕНТА ========

function createParagraph(text, options = {}) {
  const {
    bold = false,
    size = 24,      // 12pt = 24 half-points
    alignment = AlignmentType.JUSTIFIED,
    spacing = { after: 120, line: 360 },
    indent = { firstLine: convertInchesToTwip(0.5) },
    font = 'Times New Roman'
  } = options;

  return new Paragraph({
    alignment,
    spacing,
    indent: bold ? undefined : indent,
    children: [
      new TextRun({
        text,
        bold,
        size,
        font
      })
    ]
  });
}

function createHeading(text) {
  return new Paragraph({
    alignment: AlignmentType.CENTER,
    spacing: { before: 360, after: 200, line: 360 },
    children: [
      new TextRun({
        text,
        bold: true,
        size: 28,   // 14pt
        font: 'Times New Roman'
      })
    ]
  });
}

function createTitle(text) {
  return new Paragraph({
    alignment: AlignmentType.CENTER,
    spacing: { before: 600, after: 400, line: 360 },
    children: [
      new TextRun({
        text,
        bold: true,
        size: 28,
        font: 'Times New Roman'
      })
    ]
  });
}

function createReferenceItem(text, index) {
  return new Paragraph({
    alignment: AlignmentType.JUSTIFIED,
    spacing: { after: 80, line: 360 },
    indent: { left: convertInchesToTwip(0.3), hanging: convertInchesToTwip(0.3) },
    children: [
      new TextRun({
        text: `${index + 1}. ${text}`,
        size: 24,
        font: 'Times New Roman'
      })
    ]
  });
}

async function generate() {
  const children = [];

  // Заголовок
  children.push(createTitle(title));

  // Автор
  children.push(new Paragraph({
    alignment: AlignmentType.CENTER,
    spacing: { after: 400, line: 360 },
    children: [
      new TextRun({
        text: author,
        italics: true,
        size: 24,
        font: 'Times New Roman'
      })
    ]
  }));

  // Разделы
  for (const key of ['actuality', 'goal', 'materials', 'results', 'conclusions']) {
    const section = sections[key];
    children.push(createHeading(section.heading));
    for (const para of section.paragraphs) {
      children.push(createParagraph(para));
    }
  }

  // Список литературы
  children.push(createHeading(sections.references.heading));
  for (let i = 0; i < sections.references.items.length; i++) {
    children.push(createReferenceItem(sections.references.items[i], i));
  }

  const doc = new Document({
    sections: [{
      properties: {
        page: {
          margin: {
            top: convertInchesToTwip(0.79),    // ~2cm
            bottom: convertInchesToTwip(0.79),
            left: convertInchesToTwip(1.18),   // ~3cm
            right: convertInchesToTwip(0.59),  // ~1.5cm
          }
        }
      },
      children
    }]
  });

  const buffer = await Packer.toBuffer(doc);
  const outputPath = path.join(__dirname, 'thesis_neurovision.docx');
  fs.writeFileSync(outputPath, buffer);
  console.log('Файл создан:', outputPath);
  console.log('Размер:', (buffer.length / 1024).toFixed(1), 'KB');
}

generate().catch(err => {
  console.error('Ошибка:', err);
  process.exit(1);
});
